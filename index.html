<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrimeTrade | Assignment Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f9; }
        .card { border: none; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        pre { background: #212529; color: #0dcaf0; padding: 1rem; border-radius: 0.25rem; max-height: 200px; overflow: auto; }
        .status-msg { padding: 10px; border-radius: 5px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

<div class="container py-5">
    <h1 class="text-center mb-4 text-primary">PrimeTrade Dashboard</h1>
    
    <div class="row">
        <div class="col-md-5">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Register & Login</h5>
                    <ul class="nav nav-tabs mb-3" id="authTab" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#loginView">Login</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#regView">Register</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="loginView">
                            <input id="loginEmail" class="form-control mb-2" placeholder="Email">
                            <input id="loginPassword" class="form-control mb-2" type="password" placeholder="Password">
                            <button class="btn btn-success w-100" onclick="login()">Sign In</button>
                        </div>
                        <div class="tab-pane fade" id="regView">
                            <input id="regName" class="form-control mb-2" placeholder="Full Name">
                            <input id="regEmail" class="form-control mb-2" placeholder="Email">
                            <input id="regPassword" class="form-control mb-2" type="password" placeholder="Password">
                            <select id="regRole" class="form-select mb-2">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                            <button class="btn btn-primary w-100" onclick="register()">Register</button>
                        </div>
                    </div>
                    <pre id="authResult" class="mt-3 small">Status: Not Logged In</pre>
                </div>
            </div>

            <div class="card border-warning">
                <div class="card-body">
                    <h5 class="card-title">Admin Authorization Check</h5>
                    <button class="btn btn-dark w-100" onclick="adminOnly()">Test /admin-only API</button>
                    <pre id="adminResult" class="mt-3 small">Admin response will appear here...</pre>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Task Management (CRUD)</h5>
                    <div class="input-group mb-3">
                        <input id="taskTitle" type="text" class="form-control" placeholder="New Task Title...">
                        <button class="btn btn-primary" onclick="createTask()">Add Task</button>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm mb-3" onclick="getTasks()">Refresh Task List</button>
                    
                    <div id="taskList" class="list-group">
                        <p class="text-muted text-center">Login to view your tasks.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_BASE = 'http://localhost:5000/api/v1'; // Standard API Versioning [cite: 14]
    
    function getToken() { return localStorage.getItem('authToken'); }

    // --- AUTH OPERATIONS ---
    async function register() {
        const body = {
            name: document.getElementById('regName').value,
            email: document.getElementById('regEmail').value,
            password: document.getElementById('regPassword').value,
            role: document.getElementById('regRole').value
        };
        const res = await fetch(`${API_BASE}/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await res.json();
        document.getElementById('authResult').textContent = `Registration: ${res.ok ? 'Success!' : 'Failed'}\n${JSON.stringify(data, null, 2)}`;
    }

    async function login() {
        const body = {
            email: document.getElementById('loginEmail').value,
            password: document.getElementById('loginPassword').value
        };
        const res = await fetch(`${API_BASE}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await res.json();
        if (res.ok && data.token) {
            localStorage.setItem('authToken', data.token);
            document.getElementById('authResult').textContent = "Logged in successfully!";
            getTasks(); // Load tasks immediately after login
        } else {
            document.getElementById('authResult').textContent = `Login Failed: ${data.message || 'Error'}`;
        }
    }

    async function adminOnly() {
        const res = await fetch(`${API_BASE}/auth/admin-only`, {
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        const data = await res.json();
        document.getElementById('adminResult').textContent = JSON.stringify(data, null, 2);
    }

    // --- TASK CRUD OPERATIONS --- 
    async function getTasks() {
    const activeToken = localStorage.getItem('authToken'); // Get the token saved during login
    
    if (!activeToken) return;

    const res = await fetch(`${API_BASE}/tasks`, {
        headers: { 
            'Authorization': 'Bearer ' + activeToken // Ensure 'Bearer ' is exactly like this
        }
    });
    
    const data = await res.json();
    console.log("Tasks Data:", data); // Check your F12 console to see the structure!
    
    // ADJUST THIS LINE: Does your backend send { data: [...] } or just [...]?
    const tasks = data.data || data; 
    
    const list = document.getElementById('taskList');
    list.innerHTML = '';
    
    if (Array.isArray(tasks) && tasks.length > 0) {
        tasks.forEach(task => {
            list.innerHTML += `
                <div class="list-group-item d-flex justify-content-between">
                    ${task.title}
                    <button class="btn btn-danger btn-sm" onclick="deleteTask('${task._id}')">Delete</button>
                </div>`;
        });
    } else {
        list.innerHTML = '<p class="text-center text-muted">No tasks found for this user.</p>';
    }
}
    async function createTask() {
    const title = document.getElementById('taskTitle').value;
    
    // We must provide a description because your Schema says it is REQUIRED
    const description = "No description provided"; 

    const res = await fetch(`${API_BASE}/tasks`, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({ 
            title: title, 
            description: description // Added this line
        })
    });

    if (res.ok) {
        document.getElementById('taskTitle').value = '';
        getTasks();
    } else {
        const errorData = await res.json();
        alert("Error: " + errorData.message); // This will show you exactly what the backend disliked
    }
}

    async function deleteTask(id) {
        await fetch(`${API_BASE}/tasks/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        getTasks();
    }
</script>
</body>
</html>
